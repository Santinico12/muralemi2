<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <title>EMI Aniversario 75 a√±os</title>

  <!-- Librer√≠as locales -->
  <script src="three.js"></script>
  <script src="artoolkit.min.js"></script>
  <script src="artoolkit.api.js"></script>
  <script src="threex-artoolkitsource.js"></script>
  <script src="threex-artoolkitcontext.js"></script>
  <script src="threex-arbasecontrols.js"></script>
  <script src="threex-armarkercontrols.js"></script>

  <style>
    :root { color-scheme: dark; }
    body { margin:0; overflow:hidden; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Monospace; background:#000; }
    #hud {
      position:fixed; top:10px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.55); color:#fff; padding:8px 14px; border-radius:10px; z-index:20; pointer-events:auto;
    }
    #ui {
      position:fixed; left:0; right:0; bottom:10px; z-index:20;
      display:flex; gap:10px; justify-content:center; align-items:center; pointer-events:auto;
    }
    #ui button {
      padding:10px 12px; border:0; border-radius:10px; cursor:pointer;
      font-weight:600; background:rgba(255,255,255,.15); color:#fff; backdrop-filter:blur(4px);
    }
    canvas {
      position:fixed; inset:0; width:100vw; height:100vh; display:block;
      z-index:0; pointer-events:none; /* no bloquear los clicks */
    }
    #video { display:none; }
  </style>
</head>
<body>

  <div id="hud"><b>Mural AR</b> ¬∑ Apunta al marcador <b>Hiro</b></div>

  <div id="ui">
    <button id="btnPlay"    type="button">‚èØ Reproducir</button>
    <button id="btnMute"    type="button">üîà Activar sonido</button>
    <button id="btnRestart" type="button">‚ü≤ Reiniciar</button>
    <button id="btnVR"      type="button">üï∂Ô∏è Activar VR</button>
  </div>

  <video id="video" autoplay loop playsinline webkit-playsinline muted crossorigin="anonymous">
    <source src="video.mp4" type='video/ogg; codecs="theora, vorbis"'>
    <source src="video.mp4" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'>
  </video>

<script>
/* ================== VARIABLES ================== */
var scene, camera, renderer, clock;
var arToolkitSource, arToolkitContext;
var markerRoot1, mesh1;
var videoEl, videoTex;

/* Background de c√°mara (para VR/XR) */
var bgScene=null, bgCamera=null, bgMesh=null, bgTex=null;

/* XR / VR */
var xrSupported = false, xrSession = null, xrRefSpace = null, usingXRLoop = false, xrGl = null;

/* Fallback Cardboard */
var stereoMode = false;
var IPD = 0.064;
var stereoCams = { left:null, right:null };

/* UI */
var btnPlay, btnMute, btnRestart, btnVR;

init();
animate();

/* ================== INIT ================== */
function init() {
  scene = new THREE.Scene();
  scene.add(new THREE.AmbientLight(0xcccccc, 0.5));

  camera = new THREE.Camera();
  scene.add(camera);

  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setClearColor(new THREE.Color('lightgrey'), 0);
  renderer.setSize(640, 480);
  renderer.autoClear = true;
  document.body.appendChild(renderer.domElement);

  xrGl = renderer.getContext();
  if (xrGl && xrGl.makeXRCompatible) { xrGl.makeXRCompatible().catch(()=>{}); }

  if (navigator.xr && navigator.xr.isSessionSupported) {
    navigator.xr.isSessionSupported('immersive-vr')
      .then(s => { xrSupported = !!s; console.log('[XR] immersive-vr soportado:', xrSupported); })
      .catch(()=>{ xrSupported = false; });
  }

  clock = new THREE.Clock();

  /* ---- ARToolkit Source ---- */
  arToolkitSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });

  function onResize() {
    arToolkitSource.onResize();
    arToolkitSource.copySizeTo(renderer.domElement);
    if (arToolkitContext.arController !== null) {
      arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
    }
  }
  arToolkitSource.init(function(){
    onResize();
    // cuando exista el <video> de la c√°mara, preparo el background interno
    setupARBackground();
  });
  window.addEventListener('resize', onResize);

  /* ---- ARToolkit Context ---- */
  arToolkitContext = new THREEx.ArToolkitContext({
    cameraParametersUrl: 'camera_para.dat',
    detectionMode: 'mono'
  });
  arToolkitContext.init(function() {
    camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
  });

  /* ---- Marker ---- */
  markerRoot1 = new THREE.Group();
  scene.add(markerRoot1);
  new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
    type: 'pattern', patternUrl: 'hiro.patt'
  });

  /* ---- Plano con VideoTexture (tu video.mp4) ---- */
  var geometry1 = new THREE.PlaneBufferGeometry(2, 2, 4, 4);
  videoEl = document.getElementById('video');
  videoEl.muted = true; videoEl.playsInline = true;

  videoTex = new THREE.VideoTexture(videoEl);
  videoTex.minFilter = THREE.LinearFilter;
  videoTex.magFilter = THREE.LinearFilter;
  videoTex.format    = THREE.RGBFormat;

  var material1 = new THREE.MeshBasicMaterial({ map: videoTex, side: THREE.DoubleSide });
  mesh1 = new THREE.Mesh(geometry1, material1);
  mesh1.rotation.x = -Math.PI / 2;
  markerRoot1.add(mesh1);

  bindUI();
}

/* ===== Background interno con el video de la C√ÅMARA ===== */
function setupARBackground(){
  if (bgMesh || !arToolkitSource || !arToolkitSource.domElement) return;
  // usar el <video> que crea THREEx.ArToolkitSource
  var camVideo = arToolkitSource.domElement; // HTMLVideoElement
  bgTex = new THREE.VideoTexture(camVideo);
  bgTex.minFilter = THREE.LinearFilter;
  bgTex.magFilter = THREE.LinearFilter;
  bgTex.format    = THREE.RGBFormat;
  bgTex.colorSpace = THREE.SRGBColorSpace || undefined;

  bgScene  = new THREE.Scene();
  bgCamera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1); // clip-space
  var geo  = new THREE.PlaneBufferGeometry(2, 2);
  var mat  = new THREE.MeshBasicMaterial({ map: bgTex, depthTest:false, depthWrite:false });
  bgMesh   = new THREE.Mesh(geo, mat);
  bgScene.add(bgMesh);

  console.log('[BG] background de c√°mara listo');
}

/* ================== UI ================== */
function bindUI() {
  btnPlay    = document.getElementById('btnPlay');
  btnMute    = document.getElementById('btnMute');
  btnRestart = document.getElementById('btnRestart');
  btnVR      = document.getElementById('btnVR');

  renderer.domElement.style.pointerEvents = 'none';
  [btnPlay, btnMute, btnRestart, btnVR].forEach(b => { if (b) { b.style.pointerEvents='auto'; b.style.zIndex=20; }});

  updatePlayLabel(); updateMuteLabel(); updateVRLabel();

  btnPlay.addEventListener('click', async (e) => {
    e.preventDefault();
    try { videoEl.paused ? await videoEl.play() : videoEl.pause(); } catch(_){}
    updatePlayLabel();
  });

  btnMute.addEventListener('click', async (e) => {
    e.preventDefault();
    try { videoEl.muted = !videoEl.muted; await videoEl.play().catch(()=>{}); } catch(_){}
    updateMuteLabel();
  });

  btnRestart.addEventListener('click', async (e) => {
    e.preventDefault();
    try { videoEl.currentTime = 0; await videoEl.play().catch(()=>{}); } catch(_){}
    updatePlayLabel();
  });

  btnVR.addEventListener('click', async (e) => {
    e.preventDefault();
    if (isInXR() || stereoMode) await exitVR();
    else                        await enterVR();
    updateVRLabel();
  });

  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && videoEl.paused) videoEl.play().catch(()=>{});
  });

  videoEl.addEventListener('loadedmetadata', fitPlaneToVideo, { once:true });
  if (videoEl.readyState >= 1) fitPlaneToVideo();
}

function updatePlayLabel(){ btnPlay.textContent = (!videoEl || videoEl.paused) ? '‚ñ∂Ô∏è Reproducir' : '‚è∏ Pausar'; }
function updateMuteLabel(){ btnMute.textContent = (videoEl && !videoEl.muted) ? 'üîá Silenciar' : 'üîà Activar sonido'; }
function updateVRLabel(){   btnVR.textContent   = (isInXR() || stereoMode) ? '‚Ü©Ô∏è Salir VR' : 'üï∂Ô∏è Activar VR'; }

function fitPlaneToVideo() {
  if (!videoEl.videoWidth || !videoEl.videoHeight) return;
  var aspect = videoEl.videoWidth / videoEl.videoHeight;
  var W = 2, H = W / aspect;
  mesh1.geometry.dispose();
  mesh1.geometry = new THREE.PlaneBufferGeometry(W, H, 4, 4);
  mesh1.geometry.needsUpdate = true;
}

/* ================== WEBXR (immersive-vr) ================== */
function isInXR(){ return !!xrSession; }

async function enterVR() {
  setupARBackground(); // asegurar que existe

  if (xrSupported && navigator.xr) {
    try {
      xrSession = await navigator.xr.requestSession('immersive-vr', {
        optionalFeatures: ['local','local-floor','bounded-floor']
      });

      xrGl = renderer.getContext();
      if (xrGl.makeXRCompatible) await xrGl.makeXRCompatible();
      xrSession.updateRenderState({ baseLayer: new XRWebGLLayer(xrSession, xrGl) });

      xrRefSpace = await xrSession.requestReferenceSpace('local');

      usingXRLoop = true;
      xrSession.requestAnimationFrame(onXRFrame);

      try { screen.orientation && screen.orientation.lock && screen.orientation.lock('landscape'); } catch(_){}
      try {
        var el = document.documentElement;
        (el.requestFullscreen||el.webkitRequestFullscreen||function(){}) .call(el);
      } catch(_){}

      xrSession.addEventListener('end', () => {
        usingXRLoop = false;
        xrSession = null;
        try { document.fullscreenElement && document.exitFullscreen(); } catch(_){}
        animate();
        updateVRLabel();
      });

      console.log('[XR] Sesi√≥n immersive-vr iniciada');
      return;
    } catch (e) {
      console.warn('[XR] Fall√≥ immersive-vr, uso fallback Cardboard:', e);
    }
  }

  // Fallback Cardboard
  stereoMode = true;
  if (!stereoCams.left || !stereoCams.right) setupStereoCameras();
  console.log('[Stereo] Cardboard ON');
}

async function exitVR() {
  if (xrSession) { try { await xrSession.end(); } catch(_){} xrSession = null; }
  stereoMode = false;
  renderer.setScissorTest(false);
  usingXRLoop = false;
  try { document.fullscreenElement && document.exitFullscreen(); } catch(_){}
  console.log('[VR] OFF');
}

/* Loop XR: pintamos primero el FONDO (video de c√°mara), luego la escena */
function onXRFrame(time, frame) {
  if (!xrSession) return;
  xrSession.requestAnimationFrame(onXRFrame);

  update(); // ARToolkit tracking

  const pose = frame.getViewerPose(xrRefSpace);
  if (!pose) return;

  const baseLayer = xrSession.renderState.baseLayer;
  const gl = xrGl;
  gl.bindFramebuffer(gl.FRAMEBUFFER, baseLayer.framebuffer);

  for (const view of pose.views) {
    const vp = baseLayer.getViewport(view);
    renderer.setViewport(vp.x, vp.y, vp.width, vp.height);
    renderer.setScissor(vp.x, vp.y, vp.width, vp.height);

    // 1) Fondo: video de la C√ÅMARA (AR) en 2D
    if (bgScene) renderer.render(bgScene, bgCamera);

    // 2) Proyecci√≥n del ojo (opcional; con ARToolkit la dejamos como est√°)
    //    Si quieres head-tracking, descomenta estas dos l√≠neas:
    // camera.projectionMatrix.fromArray(view.projectionMatrix);
    // const inv = view.transform.inverse.matrix; camera.matrixWorld.fromArray(inv);

    // 3) Escena con el video.mp4 sobre el marcador
    renderer.render(scene, camera);
  }
}

/* ================== Fallback Cardboard (split-screen) ================== */
function setupStereoCameras() {
  stereoCams.left  = new THREE.PerspectiveCamera();
  stereoCams.right = new THREE.PerspectiveCamera();
}
function teardownStereoCameras() {
  stereoCams.left = stereoCams.right = null;
  renderer.setScissorTest(false);
}

/* ================== BUCLE ================== */
function update() {
  if (arToolkitSource.ready !== false) {
    arToolkitContext.update(arToolkitSource.domElement);
  }
}

function setInverse(target, source) {
  if (typeof target.invert === 'function') target.copy(source).invert();
  else target.getInverse(source);
}

function render() {
  // En XR renderizamos dentro de onXRFrame()
  if (usingXRLoop && isInXR()) return;

  // Normal (no XR) o Fallback Cardboard
  if (!stereoMode || !stereoCams.left) {
    renderer.setScissorTest(false);
    // Pintar background de c√°mara tambi√©n fuera de XR (para consistencia)
    if (bgScene) {
      renderer.autoClear = true;
      renderer.clear();
      renderer.render(bgScene, bgCamera);
    }
    renderer.render(scene, camera);
    return;
  }

  // Cardboard est√©reo
  var w = renderer.domElement.width, h = renderer.domElement.height;
  renderer.setScissorTest(true);

  // Ojo izquierdo
  renderer.setViewport(0, 0, w/2, h);
  renderer.setScissor(0, 0, w/2, h);
  if (bgScene) renderer.render(bgScene, bgCamera);
  renderer.render(scene, camera);

  // Ojo derecho
  renderer.setViewport(w/2, 0, w/2, h);
  renderer.setScissor(w/2, 0, w/2, h);
  if (bgScene) renderer.render(bgScene, bgCamera);
  renderer.render(scene, camera);
}

function animate() {
  if (usingXRLoop && isInXR()) return; // XR tiene su propio loop
  requestAnimationFrame(animate);
  clock.getDelta(); // delta no es cr√≠tico aqu√≠
  update();
  render();
}
</script>
</body>
</html>
