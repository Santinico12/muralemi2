<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>WebAR Video Mural (Android)</title>

  <!-- Versiones emparejadas -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.7/aframe/build/aframe-ar.min.js"></script>

  <style>
    html,body { margin:0; height:100%; background:#000; overflow:hidden; }
    #start { position:fixed; inset:0; display:grid; place-items:center; background:#000; z-index:9999; }
    #start button { font:600 16px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial; padding:12px 18px; border:0; border-radius:12px; }
    .hint { position:fixed; left:0; right:0; top:0; padding:8px 12px; color:#fff; background:rgba(0,0,0,.45); font:14px system-ui; text-align:center; z-index:10; }
    /* Asegura que el video de c치mara/canvas est칠n visibles a pantalla completa */
    video, canvas, .a-canvas { position:fixed !important; inset:0 !important; width:100vw !important; height:100vh !important; }

    /* Bot칩n para activar audio */
    #unmute {
      position: fixed; right: 10px; bottom: 10px; z-index: 11;
      padding: 10px 12px; border: 0; border-radius: 12px; cursor: pointer;
      font: 600 14px system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: rgba(255,255,255,.15); color: #fff; backdrop-filter: blur(4px);
    }
  </style>
</head>
<body>
  <div id="start"><button id="btnStart">Iniciar AR</button></div>
  <div class="hint">Abre en <b>Chrome</b>, permite la c치mara y apunta al marcador <b>Hiro</b>.</div>
  <button id="unmute" style="display:none">游댇 Activar sonido</button>

  <a-scene id="scene"
    renderer="precision: mediump; antialias: false; colorManagement: true; alpha: true; powerPreference: low-power"
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; detectionMode: mono; maxDetectionRate: 30;
          sourceWidth: 320; sourceHeight: 240; displayWidth: 320; displayHeight: 240;">

    <!-- Marcador Hiro -->
    <a-marker preset="hiro">
      <!-- El plano de video; tama침o se ajusta al metadata del video -->
      <a-video id="muralVideoPlane" src="#muralvid" rotation="-90 0 0" position="0 0 0"
               width="1.6" height="0.9" autoplay="true" loop="true"></a-video>
    </a-marker>

    <!-- Assets -->
    <a-assets timeout="60000">
      <!-- Tu video: col칩calo junto a index.html o ajusta la ruta -->
      <video id="muralvid"
             src="video.mp4"
             preload="auto"
             loop
             muted
             playsinline
             webkit-playsinline
             crossorigin="anonymous"></video>
    </a-assets>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const gate   = document.getElementById('start');
    const btn    = document.getElementById('btnStart');
    const btnAud = document.getElementById('unmute');
    const plane  = document.getElementById('muralVideoPlane');
    const vid    = document.getElementById('muralvid');

    // Mantiene "vivo" el video de la C츼MARA (AR.js crea su propio <video>)
    const ensureARCameraVideo = () => {
      const camV = document.querySelector('body video:not(#muralvid)'); // el de AR.js
      if (!camV) return;
      camV.setAttribute('autoplay',''); camV.autoplay = true;
      camV.setAttribute('muted','');    camV.muted = true;
      camV.setAttribute('playsinline',''); camV.playsInline = true;
      const tryPlay = () => camV.play().catch(()=>setTimeout(tryPlay, 400));
      tryPlay();
    };
    new MutationObserver(ensureARCameraVideo).observe(document.body, {childList:true, subtree:true});

    // Ajusta el tama침o del plano al aspecto real del video (evita estiramientos)
    const fitPlaneToVideo = () => {
      if (!vid.videoWidth || !vid.videoHeight) return;
      const aspect = vid.videoWidth / vid.videoHeight; // ancho/alto
      const baseW = 1.6;              // ancho base en "metros" de A-Frame
      const baseH = baseW / aspect;   // alto seg칰n aspecto
      plane.setAttribute('width',  baseW);
      plane.setAttribute('height', baseH);
      console.log('[AR] video aspect', aspect.toFixed(3), 'size', baseW.toFixed(2),'x',baseH.toFixed(2));
    };

    // Iniciar AR + reproducir el video del mural
    btn.addEventListener('click', () => {
      gate.style.display = 'none';

      // Asegura flags de autoplay inline para el video del mural
      vid.setAttribute('muted','');      vid.muted = true;    // autoplay m칩vil requiere mute
      vid.setAttribute('playsinline',''); vid.playsInline = true;
      vid.setAttribute('autoplay','');   // no todos respetan, pero ayuda

      // Reproducir con reintentos suaves (por si el decodificador tarda)
      const tryPlayMural = () => vid.play().catch(()=>setTimeout(tryPlayMural, 300));
      tryPlayMural();

      // Mostrar bot칩n para activar sonido manualmente (gesto del usuario)
      btnAud.style.display = 'block';

      // Ajusta el plano cuando haya metadatos del video
      if (vid.readyState >= 1) fitPlaneToVideo();
      vid.addEventListener('loadedmetadata', fitPlaneToVideo, {once:true});

      // "Desbloquea" tambi칠n el video de c치mara
      setTimeout(ensureARCameraVideo, 600);
    });

    // Activar audio manualmente (necesita gesto del usuario)
    btnAud.addEventListener('click', async () => {
      try {
        vid.muted = false;
        await vid.play();
        btnAud.textContent = '游댆 Silenciar';
        btnAud.onclick = () => { vid.muted = true; vid.play(); btnAud.textContent = '游댇 Activar sonido'; };
      } catch (e) {
        console.warn('No se pudo activar sonido:', e && (e.name || e.message));
      }
    });

    // Si vuelve del background y algo qued칩 pausado, reintenta
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        if (vid.paused) vid.play().catch(()=>{});
        ensureARCameraVideo();
      }
    });

    // Si se pierde el contexto WebGL, recarga (previene cuelgues en algunos Android)
    const sceneEl = document.getElementById('scene');
    sceneEl.addEventListener('webglcontextlost', (e) => {
      console.warn('[AR] WebGL context lost, reloading...');
      e.preventDefault();
      setTimeout(()=>location.reload(), 300);
    }, false);
  </script>
</body>
</html>
