<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Mural AR (Video)</title>

  <!-- Mantengo las versiones que a ti te funcionan con la c√°mara -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }

    .arjs-loader {
      height: 100%; width: 100%; position: absolute; top: 0; left: 0;
      background-color: rgba(0, 0, 0, 0.8); z-index: 9999;
      display: flex; justify-content: center; align-items: center;
    }
    .arjs-loader div { text-align: center; font-size: 1.25em; color: white; }

    #error-msg {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(255, 0, 0, 0.9); color: white; padding: 20px; border-radius: 10px;
      z-index: 10000; display: none; max-width: 80%; text-align: center;
    }
    #btn-reload {
      margin-top: 10px; padding: 10px 20px; background: white; color: red;
      border: none; border-radius: 5px; font-size: 16px; cursor: pointer;
    }

    #instrucciones {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7); color: white; padding: 15px 25px; border-radius: 10px;
      z-index: 1000; text-align: center; max-width: 90%;
    }
    #instrucciones h3 { margin: 0 0 10px 0; font-size: 18px; }
    #instrucciones p { margin: 5px 0; font-size: 14px; }
    #instrucciones a { color: #4CAF50; text-decoration: none; font-weight: bold; }

    /* Bot√≥n para activar/desactivar audio del video */
    #unmute {
      position: absolute; right: 10px; bottom: 10px; z-index: 1000;
      padding: 10px 12px; border: 0; border-radius: 12px; cursor: pointer;
      font: 600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: rgba(255,255,255,.15); color: #fff; backdrop-filter: blur(4px);
      display: none;
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div class="arjs-loader"><div>Cargando AR... üì±</div></div>

  <!-- Mensajes de error -->
  <div id="error-msg">
    <h3>‚ö†Ô∏è Error de C√°mara</h3>
    <p id="error-text"></p>
    <button id="btn-reload" onclick="location.reload()">Reintentar</button>
  </div>

  <!-- Instrucciones -->
  <div id="instrucciones">
    <h3>üì± Mural AR (Video)</h3>
    <p>Apunta la c√°mara al marcador Hiro</p>
    <p><a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" target="_blank">Ver marcador</a></p>
  </div>

  <!-- Bot√≥n de audio del video -->
  <button id="unmute">üîà Activar sonido</button>

  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; videoConstraints: { facingMode: 'environment' };"
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; precision: medium;"
    loading-screen="enabled: false">

    <!-- Assets -->
    <a-assets timeout="60000">
      <!-- Tu VIDEO: col√≥calo junto a index.html (o ajusta el src) -->
      <video id="muralvid"
             src="video.mp4"
             preload="auto"
             loop
             muted
             playsinline
             webkit-playsinline
             crossorigin="anonymous"></video>
    </a-assets>

    <!-- C√°mara -->
    <a-entity camera></a-entity>

    <!-- Marcador Hiro -->
    <a-marker preset="hiro">
      <!-- Plano de video como ‚Äúmural‚Äù -->
      <a-video id="muralVideoPlane"
               src="#muralvid"
               position="0 0 0.01"
               rotation="-90 0 0"
               width="2"
               height="1"
               autoplay="true"
               loop="true">
      </a-video>

      <!-- Marco decorativo detr√°s (opcional, lo mantengo) -->
      <a-box position="0 0 -0.02"
             rotation="-90 0 0"
             width="2.2" height="2.2" depth="0.08"
             color="#654321">
      </a-box>
    </a-marker>
  </a-scene>

  <script>
    let cameraStarted = false;

    // -------- tu l√≥gica original (mantenida) ----------
    function mostrarError(mensaje) {
      const errorDiv = document.getElementById('error-msg');
      const errorText = document.getElementById('error-text');
      const loader = document.querySelector('.arjs-loader');

      if (loader) loader.style.display = 'none';
      errorText.textContent = mensaje;
      errorDiv.style.display = 'block';
    }

    document.querySelector('a-scene').addEventListener('camera-init', () => {
      cameraStarted = true;
      console.log('‚úì C√°mara iniciada correctamente');
    });

    window.addEventListener('load', function () {
      setTimeout(() => {
        const loader = document.querySelector('.arjs-loader');
        if (loader && cameraStarted) loader.style.display = 'none';
      }, 3000);
    });

    setTimeout(() => {
      const instrucciones = document.getElementById('instrucciones');
      if (instrucciones && cameraStarted) {
        instrucciones.style.transition = 'opacity 1s';
        instrucciones.style.opacity = '0';
        setTimeout(() => { instrucciones.style.display = 'none'; }, 1000);
      }
    }, 10000);

    setTimeout(() => {
      if (!cameraStarted) {
        navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
        })
        .then(stream => {
          console.log('‚úì Permisos de c√°mara OK');
          stream.getTracks().forEach(track => track.stop());
        })
        .catch(err => {
          console.error('Error de c√°mara:', err);
          let mensaje = '';
          if (err.name === 'NotAllowedError') {
            mensaje = 'Permisos denegados. Ve a Ajustes ‚Üí Apps ‚Üí Chrome ‚Üí Permisos ‚Üí C√°mara';
          } else if (err.name === 'NotReadableError') {
            mensaje = 'La c√°mara est√° en uso por otra app. Cierra todas las apps y recarga.';
          } else if (err.name === 'NotFoundError') {
            mensaje = 'No se encontr√≥ ninguna c√°mara en el dispositivo.';
          } else {
            mensaje = `Error: ${err.name} - ${err.message}`;
          }
          mostrarError(mensaje);
        });
      }
    }, 4000);

    window.addEventListener('arjs-video-loaded', () => {
      console.log('‚úì Video AR (c√°mara) cargado');
      cameraStarted = true;
    });
    // -------- fin tu l√≥gica original ----------

    // -------- funciones a√±adidas para el VIDEO del mural --------
    const vid = document.getElementById('muralvid');
    const plane = document.getElementById('muralVideoPlane');
    const btnAud = document.getElementById('unmute');

    // Ajusta el plano al aspect ratio real del MP4 (evita estiramientos)
    function fitPlaneToVideo() {
      if (!vid.videoWidth || !vid.videoHeight) return;
      const aspect = vid.videoWidth / vid.videoHeight; // ancho/alto
      const baseW = 2;              // ancho ‚Äúf√≠sico‚Äù del mural
      const baseH = baseW / aspect; // alto en funci√≥n del aspect ratio
      plane.setAttribute('width', baseW);
      plane.setAttribute('height', baseH);
      console.log('[Mural] aspect', aspect.toFixed(3), 'size', baseW.toFixed(2), 'x', baseH.toFixed(2));
    }

    // Intento de autoplay (silenciado) ‚Äî necesario en m√≥vil
    function tryPlayVideoMuted() {
      vid.muted = true;
      vid.playsInline = true;
      vid.setAttribute('playsinline', '');
      vid.setAttribute('muted', '');
      vid.setAttribute('autoplay', '');
      const tryPlay = () => vid.play().catch(() => setTimeout(tryPlay, 300));
      tryPlay();
      btnAud.style.display = 'block'; // permitimos activar sonido manualmente
    }

    // Bot√≥n para activar/desactivar audio (gesto del usuario)
    btnAud.addEventListener('click', async () => {
      try {
        if (vid.muted) {
          vid.muted = false;
          await vid.play();
          btnAud.textContent = 'üîá Silenciar';
        } else {
          vid.muted = true;
          await vid.play();
          btnAud.textContent = 'üîà Activar sonido';
        }
      } catch (e) {
        console.warn('Audio toggle error:', e && (e.name || e.message));
      }
    });

    // Cuando el video tenga metadatos, ajusta el plano
    if (vid.readyState >= 1) fitPlaneToVideo();
    vid.addEventListener('loadedmetadata', fitPlaneToVideo);

    // Dispara el autoplay del MP4 cuando la escena est√© lista y la c√°mara haya arrancado
    document.querySelector('a-scene').addEventListener('loaded', () => {
      // peque√±o delay para dar tiempo a AR.js a crear el video de c√°mara
      setTimeout(() => { tryPlayVideoMuted(); }, 600);
    });

    // Si regresa del background y algo queda pausado, reintenta
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        if (vid.paused) vid.play().catch(() => {});
      }
    });
    // -------- fin funciones a√±adidas --------
  </script>
</body>
</html>
