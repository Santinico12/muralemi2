<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Mural AR (Video + VR)</title>

  <!-- Tu combo estable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; font-family: Arial, sans-serif; }
    .arjs-loader {
      height:100%; width:100%; position:absolute; top:0; left:0;
      background: rgba(0,0,0,.8); z-index:9999; display:flex; justify-content:center; align-items:center;
    }
    .arjs-loader div { color:#fff; font-size:1.2em; text-align:center; }

    #error-msg {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      background: rgba(255,0,0,.9); color:#fff; padding:20px; border-radius:10px; z-index:10000;
      display:none; max-width:80%; text-align:center;
    }
    #btn-reload {
      margin-top:10px; padding:10px 20px; background:#fff; color:#c00; border:0; border-radius:6px; font-size:16px; cursor:pointer;
    }

    #instrucciones {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      background: rgba(0,0,0,.7); color:#fff; padding:12px 20px; border-radius:10px; z-index:1000; text-align:center; max-width:90%;
    }
    #instrucciones h3 { margin:0 0 6px 0; font-size:18px; }
    #instrucciones p { margin:4px 0; font-size:14px; }
    #instrucciones a { color:#4CAF50; text-decoration:none; font-weight:bold; }

    /* Controles */
    #controls {
      position:fixed; bottom:10px; left:10px; right:10px; display:flex; gap:10px; justify-content:center; z-index:1001;
    }
    #controls button {
      padding:10px 12px; border:0; border-radius:10px; cursor:pointer; font:600 14px system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: rgba(255,255,255,.15); color:#fff; backdrop-filter: blur(4px);
    }

    /* Asegurar que el video/canvas de la c√°mara queden visibles a pantalla completa */
    video, canvas, .a-canvas { position:fixed !important; inset:0 !important; width:100vw !important; height:100vh !important; }
  </style>
</head>
<body>
  <div class="arjs-loader"><div>Cargando AR... üì±</div></div>

  <div id="error-msg">
    <h3>‚ö†Ô∏è Error de C√°mara</h3>
    <p id="error-text"></p>
    <button id="btn-reload" onclick="location.reload()">Reintentar</button>
  </div>

  <div id="instrucciones">
    <h3>üì± Mural AR</h3>
    <p>Apunta la c√°mara al marcador Hiro</p>
    <p><a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" target="_blank">Ver marcador</a></p>
  </div>

  <!-- Controles: iniciar AR, activar sonido, activar/salir VR -->
  <div id="controls">
    <button id="btnStart">‚ñ∂Ô∏è Iniciar AR</button>
    <button id="btnUnmute" style="display:none">üîà Activar sonido</button>
    <button id="btnVR">üï∂Ô∏è Activar VR</button>
  </div>

  <a-scene
    id="scene"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; videoConstraints: {facingMode: 'environment'};"
    vr-mode-ui="enabled: true"
    renderer="logarithmicDepthBuffer: true; precision: medium; alpha: true;"
    loading-screen="enabled: false">

    <!-- Assets: tu video del mural -->
    <a-assets timeout="60000">
      <!-- Coloca video.mp4 junto a index.html, o ajusta la ruta -->
      <video id="muralvid"
             src="video.mp4"
             preload="auto"
             loop
             muted
             playsinline
             webkit-playsinline
             crossorigin="anonymous"></video>
    </a-assets>

    <a-entity camera></a-entity>

    <a-marker preset="hiro">
      <!-- Plano del video como mural (ajustaremos su tama√±o al metadata del video) -->
      <a-video id="muralVideoPlane" src="#muralvid"
               rotation="-90 0 0" position="0 0 0.01"
               width="2" height="1.125"  <!-- 16:9 por defecto; se recalcula cuando cargue -->
               autoplay="true" loop="true" webkit-playsinline playsinline>
      </a-video>

      <!-- Marco decorativo detr√°s (opcional) -->
      <a-box position="0 0 -0.05" rotation="-90 0 0" width="2.2" height="1.3" depth="0.08" color="#654321"></a-box>
    </a-marker>
  </a-scene>

  <script>
    let cameraStarted = false;

    // ---------- UI helpers ----------
    function mostrarError(mensaje) {
      const errorDiv = document.getElementById('error-msg');
      const errorText = document.getElementById('error-text');
      const loader = document.querySelector('.arjs-loader');
      if (loader) loader.style.display = 'none';
      errorText.textContent = mensaje;
      errorDiv.style.display = 'block';
    }

    // ---------- Mantener vivo el <video> de la C√ÅMARA (AR.js) ----------
    const ensureARCameraVideo = () => {
      // Busca un <video> que NO sea el asset #muralvid (que es tu video del mural)
      const vids = Array.from(document.querySelectorAll('video'));
      const camV = vids.find(v => v.id !== 'muralvid' && (v.srcObject || v.tagName.toLowerCase()==='video'));
      if (!camV) return;

      camV.setAttribute('autoplay',''); camV.autoplay = true;
      camV.setAttribute('muted','');    camV.muted = true;
      camV.setAttribute('playsinline',''); camV.playsInline = true;

      const tryPlay = () => camV.play().catch(() => setTimeout(tryPlay, 400));
      tryPlay();
    };
    // Observa el DOM por si AR.js recrea el <video> interno
    new MutationObserver(ensureARCameraVideo).observe(document.body, {childList:true, subtree:true});

    // ---------- Ajustar tama√±o del plano al aspect real del video ----------
    const plane = document.getElementById('muralVideoPlane');
    const vid   = document.getElementById('muralvid');
    function fitPlaneToVideo() {
      if (!vid.videoWidth || !vid.videoHeight) return;
      const aspect = vid.videoWidth / vid.videoHeight; // ancho/alto
      const baseW = 2;                  // ancho en "metros" de A-Frame
      const baseH = baseW / aspect;     // alto segun aspecto del video
      plane.setAttribute('width',  baseW);
      plane.setAttribute('height', baseH);
      console.log('[AR] video aspect', aspect.toFixed(3), 'plane', baseW.toFixed(2)+'x'+baseH.toFixed(2));
    }

    // ---------- Eventos de A-Frame / AR.js ----------
    document.querySelector('a-scene').addEventListener('camera-init', () => {
      cameraStarted = true;
      console.log('‚úì C√°mara iniciada correctamente');
    });

    window.addEventListener('arjs-video-loaded', () => {
      console.log('‚úì Video AR (c√°mara) cargado');
      cameraStarted = true;
    });

    // Quita el loader cuando la c√°mara ya est√°
    window.addEventListener('load', () => {
      setTimeout(() => {
        const loader = document.querySelector('.arjs-loader');
        if (loader && cameraStarted) loader.style.display = 'none';
      }, 1200);
    });

    // Ocultar instrucciones al rato si ya est√° la c√°mara
    setTimeout(() => {
      const instrucciones = document.getElementById('instrucciones');
      if (instrucciones && cameraStarted) {
        instrucciones.style.transition = 'opacity 1s';
        instrucciones.style.opacity = '0';
        setTimeout(() => { instrucciones.style.display = 'none'; }, 1000);
      }
    }, 10000);

    // ---------- Verificaci√≥n de permisos (fallback) ----------
    setTimeout(() => {
      if (!cameraStarted && navigator.mediaDevices?.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }, audio:false })
          .then(stream => { console.log('‚úì Permisos de c√°mara OK'); stream.getTracks().forEach(t=>t.stop()); })
          .catch(err => {
            console.error('Error de c√°mara:', err);
            let msg = '';
            if (err.name === 'NotAllowedError')   msg = 'Permisos denegados. Ajustes ‚Üí Apps ‚Üí Chrome ‚Üí Permisos ‚Üí C√°mara';
            else if (err.name === 'NotReadableError') msg = 'La c√°mara est√° en uso por otra app. Cierra todas las apps y recarga.';
            else if (err.name === 'NotFoundError')    msg = 'No se encontr√≥ ninguna c√°mara en el dispositivo.';
            else msg = `Error: ${err.name} - ${err.message}`;
            mostrarError(msg);
          });
      }
    }, 3000);

    // ---------- Bot√≥n: Iniciar AR (gesto del usuario) + reproducir video mural ----------
    const btnStart = document.getElementById('btnStart');
    const btnUnmute = document.getElementById('btnUnmute');
    btnStart.addEventListener('click', () => {
      // Mural video: autoplay en mute (pol√≠ticas m√≥viles)
      vid.setAttribute('muted',''); vid.muted = true;
      vid.setAttribute('playsinline',''); vid.playsInline = true;
      vid.setAttribute('autoplay','');
      const tryPlayMural = () => vid.play().catch(() => setTimeout(tryPlayMural, 300));
      tryPlayMural();

      // Ajusta el plano cuando haya metadata
      if (vid.readyState >= 1) fitPlaneToVideo();
      vid.addEventListener('loadedmetadata', fitPlaneToVideo, {once:true});

      // Mantener vivo el video de c√°mara tambi√©n
      setTimeout(ensureARCameraVideo, 400);

      // Mostrar control de audio
      btnUnmute.style.display = 'inline-block';
    });

    // ---------- Bot√≥n: Activar/Silenciar sonido del video del mural ----------
    btnUnmute.addEventListener('click', async () => {
      try {
        vid.muted = !vid.muted;
        await vid.play();
        btnUnmute.textContent = vid.muted ? 'üîà Activar sonido' : 'üîá Silenciar';
      } catch (e) {
        console.warn('No se pudo alternar sonido:', e?.name || e?.message || e);
      }
    });

    // ---------- Bot√≥n: Activar / Salir VR ----------
    const sceneEl = document.getElementById('scene');
    const btnVR   = document.getElementById('btnVR');

    const updateVRLabel = () => {
      btnVR.textContent = sceneEl.is('vr-mode') ? '‚Ü©Ô∏è Salir VR' : 'üï∂Ô∏è Activar VR';
    };
    btnVR.addEventListener('click', () => {
      if (sceneEl.is('vr-mode')) sceneEl.exitVR(); else sceneEl.enterVR();
    });
    sceneEl.addEventListener('enter-vr', updateVRLabel);
    sceneEl.addEventListener('exit-vr',  updateVRLabel);
    updateVRLabel();

    // ---------- Si se pierde el contexto WebGL, recarga (previene cuelgues) ----------
    sceneEl.addEventListener('webglcontextlost', (e) => {
      console.warn('[AR] WebGL context lost, reloading...');
      e.preventDefault();
      setTimeout(() => location.reload(), 300);
    }, false);
  </script>
</body>
</html>

