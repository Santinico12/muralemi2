<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Mural AR (Video + VR, plano con textura)</title>

  <!-- Combo estable que no te apaga la c√°mara -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; font-family: Arial, sans-serif; }
    .arjs-loader {
      height:100%; width:100%; position:absolute; top:0; left:0;
      background: rgba(0,0,0,.8); z-index:9999; display:flex; justify-content:center; align-items:center;
    }
    .arjs-loader div { color:#fff; font-size:1.2em; text-align:center; }

    #error-msg {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      background: rgba(255,0,0,.9); color:#fff; padding:20px; border-radius:10px; z-index:10000;
      display:none; max-width:80%; text-align:center;
    }
    #btn-reload {
      margin-top:10px; padding:10px 20px; background:#fff; color:#c00; border:0; border-radius:6px; font-size:16px; cursor:pointer;
    }

    #instrucciones {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      background: rgba(0,0,0,.7); color:#fff; padding:12px 20px; border-radius:10px; z-index:1000; text-align:center; max-width:90%;
    }
    #instrucciones h3 { margin:0 0 6px 0; font-size:18px; }
    #instrucciones p { margin:4px 0; font-size:14px; }
    #instrucciones a { color:#4CAF50; text-decoration:none; font-weight:bold; }

    #controls {
      position:fixed; bottom:10px; left:10px; right:10px; display:flex; gap:10px; justify-content:center; z-index:1001;
    }
    #controls button {
      padding:10px 12px; border:0; border-radius:10px; cursor:pointer; font:600 14px system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: rgba(255,255,255,.15); color:#fff; backdrop-filter: blur(4px);
    }

    /* Asegurar que el video/canvas de la C√ÅMARA est√©n visibles a pantalla completa */
    video, canvas, .a-canvas { position:fixed !important; inset:0 !important; width:100vw !important; height:100vh !important; }
  </style>
</head>
<body>
  <div class="arjs-loader"><div>Cargando AR... üì±</div></div>

  <div id="error-msg">
    <h3>‚ö†Ô∏è Error de C√°mara</h3>
    <p id="error-text"></p>
    <button id="btn-reload" onclick="location.reload()">Reintentar</button>
  </div>

  <div id="instrucciones">
    <h3>üì± Mural AR</h3>
    <p>Apunta la c√°mara al marcador Hiro</p>
    <p><a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" target="_blank">Ver marcador</a></p>
  </div>

  <div id="controls">
    <button id="btnStart">‚ñ∂Ô∏è Iniciar AR</button>
    <button id="btnUnmute" style="display:none">üîà Activar sonido</button>
    <button id="btnVR">üï∂Ô∏è Activar VR</button>
  </div>

  <a-scene
    id="scene"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; videoConstraints: {facingMode: 'environment'};"
    vr-mode-ui="enabled: true"
    renderer="logarithmicDepthBuffer: true; precision: medium; alpha: true;"
    loading-screen="enabled: false">

    <!-- Assets -->
    <a-assets timeout="60000">
      <!-- IMPORTANTE: mismo origen (GitHub Pages) para evitar CORS en textura de video -->
      <video id="muralvid"
             src="video.mp4"
             preload="auto"
             loop
             muted
             playsinline
             webkit-playsinline></video>
    </a-assets>

    <a-entity camera></a-entity>

    <a-marker preset="hiro">
      <!-- MURAL: plano con textura de video (m√°s estable que <a-video> con AR.js) -->
      <a-entity id="muralPlane"
                geometry="primitive: plane; width: 2; height: 1.125"  <!-- 16:9 por defecto -->
                material="src: #muralvid; shader: flat; side: double; transparent: false"
                position="0 0 0.01"
                rotation="-90 0 0">
      </a-entity>

      <!-- Marco (opcional). Si estorba, com√©ntalo. -->
      <a-box position="0 0 -0.05" rotation="-90 0 0" width="2.2" height="1.3" depth="0.08" color="#654321"></a-box>
    </a-marker>
  </a-scene>

  <script>
    let cameraStarted = false;

    const sceneEl    = document.getElementById('scene');
    const planeEl    = document.getElementById('muralPlane');
    const vid        = document.getElementById('muralvid');
    const btnStart   = document.getElementById('btnStart');
    const btnUnmute  = document.getElementById('btnUnmute');
    const btnVR      = document.getElementById('btnVR');

    // ---------- UI helpers ----------
    function mostrarError(mensaje) {
      const errorDiv = document.getElementById('error-msg');
      const errorText = document.getElementById('error-text');
      const loader = document.querySelector('.arjs-loader');
      if (loader) loader.style.display = 'none';
      errorText.textContent = mensaje;
      errorDiv.style.display = 'block';
    }

    // ---------- Mantener vivo el <video> de la C√ÅMARA (AR.js) ----------
    const ensureARCameraVideo = () => {
      const vids = Array.from(document.querySelectorAll('video'));
      const camV = vids.find(v => v !== vid && (v.srcObject || v.getAttribute('src')==='' ));
      if (!camV) return;
      camV.setAttribute('autoplay',''); camV.autoplay = true;
      camV.setAttribute('muted','');    camV.muted = true;
      camV.setAttribute('playsinline',''); camV.playsInline = true;
      const tryPlay = () => camV.play().catch(() => setTimeout(tryPlay, 400));
      tryPlay();
    };
    new MutationObserver(ensureARCameraVideo).observe(document.body, {childList:true, subtree:true});

    // ---------- Ajustar tama√±o del plano al aspecto real del video ----------
    function fitPlaneToVideo() {
      if (!vid.videoWidth || !vid.videoHeight) return;
      const aspect = vid.videoWidth / vid.videoHeight; // ancho/alto
      const baseW = 2;                 // ancho del ‚Äúmural‚Äù (metros en A-Frame)
      const baseH = baseW / aspect;    // alto seg√∫n aspecto
      planeEl.setAttribute('geometry', `primitive: plane; width: ${baseW}; height: ${baseH}`);
      console.log('[AR] video aspect', aspect.toFixed(3), 'plane', baseW.toFixed(2)+'x'+baseH.toFixed(2));
    }

    // ---------- Eventos A-Frame / AR.js ----------
    sceneEl.addEventListener('camera-init', () => {
      cameraStarted = true;
      console.log('‚úì C√°mara iniciada correctamente');
    });

    window.addEventListener('arjs-video-loaded', () => {
      console.log('‚úì Video AR (c√°mara) cargado');
      cameraStarted = true;
    });

    window.addEventListener('load', () => {
      setTimeout(() => {
        const loader = document.querySelector('.arjs-loader');
        if (loader && cameraStarted) loader.style.display = 'none';
      }, 1200);
    });

    setTimeout(() => {
      const instrucciones = document.getElementById('instrucciones');
      if (instrucciones && cameraStarted) {
        instrucciones.style.transition = 'opacity 1s';
        instrucciones.style.opacity = '0';
        setTimeout(() => { instrucciones.style.display = 'none'; }, 1000);
      }
    }, 10000);

    // ---------- Fallback de permisos ----------
    setTimeout(() => {
      if (!cameraStarted && navigator.mediaDevices?.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }, audio:false })
          .then(stream => { console.log('‚úì Permisos de c√°mara OK'); stream.getTracks().forEach(t=>t.stop()); })
          .catch(err => {
            console.error('Error de c√°mara:', err);
            let msg = '';
            if (err.name === 'NotAllowedError')   msg = 'Permisos denegados. Ajustes ‚Üí Apps ‚Üí Chrome ‚Üí Permisos ‚Üí C√°mara';
            else if (err.name === 'NotReadableError') msg = 'La c√°mara est√° en uso por otra app. Cierra todas las apps y recarga.';
            else if (err.name === 'NotFoundError')    msg = 'No se encontr√≥ ninguna c√°mara en el dispositivo.';
            else msg = `Error: ${err.name} - ${err.message}`;
            mostrarError(msg);
          });
      }
    }, 3000);

    // ---------- Iniciar AR + reproducir el VIDEO del mural ----------
    btnStart.addEventListener('click', () => {
      // Reglas para autoplay en m√≥vil
      vid.setAttribute('muted',''); vid.muted = true;
      vid.setAttribute('playsinline',''); vid.playsInline = true;
      vid.setAttribute('autoplay','');

      const tryPlayMural = () => vid.play().catch(() => setTimeout(tryPlayMural, 300));
      tryPlayMural();

      // Ajusta tama√±o cuando haya metadata
      if (vid.readyState >= 1) fitPlaneToVideo();
      vid.addEventListener('loadedmetadata', fitPlaneToVideo, {once:true});

      // Mantener vivo video de c√°mara
      setTimeout(ensureARCameraVideo, 400);

      // Mostrar bot√≥n de sonido
      btnUnmute.style.display = 'inline-block';
    });

    // ---------- Activar/Silenciar audio del mural ----------
    btnUnmute.addEventListener('click', async () => {
      try {
        vid.muted = !vid.muted;
        await vid.play();
        btnUnmute.textContent = vid.muted ? 'üîà Activar sonido' : 'üîá Silenciar';
      } catch (e) {
        console.warn('No se pudo alternar sonido:', e?.name || e?.message || e);
      }
    });

    // ---------- Activar / Salir VR ----------
    const updateVRLabel = () => { btnVR.textContent = sceneEl.is('vr-mode') ? '‚Ü©Ô∏è Salir VR' : 'üï∂Ô∏è Activar VR'; };
    btnVR.addEventListener('click', () => { if (sceneEl.is('vr-mode')) sceneEl.exitVR(); else sceneEl.enterVR(); });
    sceneEl.addEventListener('enter-vr', updateVRLabel);
    sceneEl.addEventListener('exit-vr',  updateVRLabel);
    updateVRLabel();

    // ---------- Si se pierde WebGL, recarga ----------
    sceneEl.addEventListener('webglcontextlost', (e) => {
      console.warn('[AR] WebGL context lost, reloading...');
      e.preventDefault();
      setTimeout(() => location.reload(), 300);
    }, false);
  </script>
</body>
</html>


